name: Generate TORRENT RULE-SET of Clash
on:
  workflow_dispatch:
  schedule:
    - cron: "0 5 * * *"
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Set date
        run: echo "TZ=Europa/Moscow" >> $GITHUB_ENV
      - name: Set variables
        run: |
          echo "COMMIT_DATE=$(date "+%Y-%m-%d %H:%M")" >> $GITHUB_ENV
          echo "trackers_anime=https://raw.githubusercontent.com/DeSireFire/animeTrackerList/master/AT_all.txt" >> $GITHUB_ENV
          echo "trackers_all=https://raw.githubusercontent.com/XIU2/TrackersListCollection/master/all.txt" >> $GITHUB_ENV
          echo "trackers_all_alt1=https://raw.githubusercontent.com/ngosang/trackerslist/master/trackers_all.txt" >> $GITHUB_ENV
      
      - name: Checkout the "hidden" branch
        uses: actions/checkout@v3
      
      - name: Generate trackers.yaml file (Clash RULE-SET format)
        run: |
          echo "payload:" > torrents+anime.yaml
          (
            curl -sSL "${trackers_anime}"
            curl -sSL "${trackers_all}"
            curl -sSL "${trackers_all_alt1}"
          ) | grep -v '^$' | sed "s/^ *//;s/ *$//" | sort -u | awk '!seen[$0]++' | while read line; do
            target=$(echo "$line" | sed "s/^.*:\/\///;s/\/.*$//")
            if [[ "$target" =~ ^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
              echo "  - IP-CIDR,${target}/32" >> torrents+anime.yaml
            elif [[ "$target" =~ ^AS[0-9]+$ ]]; then
              num=$(echo "$target" | sed 's/AS//')
              echo "  - IP-ASN,${num}" >> torrents+anime.yaml
            elif [[ "$target" =~ ^[a-zA-Z0-9.-]+$ ]]; then
              echo "  - DOMAIN-SUFFIX,${target}" >> torrents+anime.yaml
            fi
          done
      
      - name: Git push assets to "release" branch
        run: |
          git config user.name github-actions
          git config user.email actions@github.com
          git add .
          git commit -m "${{ env.COMMIT_DATE }}" || true
          git push

      - name: Purge jsdelivr CDN
        run: |
          for file in $(ls *.yaml); do
            curl -i "https://purge.jsdelivr.net/gh/${{ github.repository }}@main/${file}"
          done
